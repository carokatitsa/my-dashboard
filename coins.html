<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Coin Archive Pro + Sort</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --gold: #f1c40f; --text: #e0e0e0; --blue: #3498db; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .admin-panel { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #333; margin-bottom: 20px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .inputs-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input, textarea, select { background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; }
        
        /* –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        .filter-bar { display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-top: 20px; }
        .search-input { border: 2px solid var(--gold) !important; font-size: 16px !important; background: #111 !important; }
        .sort-select { border: 2px solid var(--blue) !important; cursor: pointer; }

        .btn-main { background: var(--gold); color: #000; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.3s; }
        .btn-main.edit-mode { background: var(--blue); color: #fff; }

        .coin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        .coin-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #333; position: relative; transition: 0.3s; }
        .coin-card:hover { border-color: var(--gold); }
        
        .coin-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 5px; background: #000; padding: 5px; min-height: 150px; }
        .coin-gallery img { width: 100%; height: 140px; object-fit: cover; cursor: pointer; border-radius: 4px; }

        .coin-info { padding: 20px; }
        .coin-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .coin-id { color: var(--gold); font-size: 22px; font-weight: bold; }
        .coin-price { font-size: 18px; font-weight: bold; }
        .coin-desc { color: #bbb; font-size: 14px; line-height: 1.5; margin-bottom: 15px; white-space: pre-wrap; }

        .card-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-card { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; background: #222; color: #fff; }
        .btn-del { background: #c0392b; position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; z-index: 5; }
    </style>
</head>
<body>

<div class="container">
    <div class="admin-panel">
        <div class="inputs-row">
            <input type="text" id="cNum" placeholder="–ù–æ–º–µ—Ä (–Ω–∞–ø—Ä. 102)">
            <input type="text" id="cPrice" placeholder="–¶–µ–Ω–∞ (–Ω–∞–ø—Ä. 500 $)">
            <select id="cStatus">
                <option value="–í –Ω–∞–ª–∏—á–∏–∏">–í –Ω–∞–ª–∏—á–∏–∏</option>
                <option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω–æ</option>
            </select>
        </div>
        <textarea id="cUrls" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é..." rows="2"></textarea>
        <textarea id="cDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–Ω–µ—Ç—ã..." rows="2" style="margin-top:10px"></textarea>
        
        <button id="mainBtn" class="btn-main" onclick="saveData()">–î–û–ë–ê–í–ò–¢–¨ –í –ë–ê–ó–£</button>
        <button id="cancelBtn" onclick="resetForm()" style="display:none; background:none; color:gray; border:none; width:100%; margin-top:10px; cursor:pointer;">–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        
        <div class="filter-bar">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="render()">
            <select id="sortSelect" class="sort-select" onchange="render()">
                <option value="lastUpdate">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</option>
                <option value="numAsc">–ü–æ –Ω–æ–º–µ—Ä—É (1-9)</option>
                <option value="alpha">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ê-–Ø)</option>
            </select>
        </div>
    </div>

    <div id="coinGrid" class="coin-grid"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3QRDLzkS9-NnupC5KN65fMv1j39ZovsI",
        authDomain: "my-dashboard-dc67a.firebaseapp.com",
        projectId: "my-dashboard-dc67a",
        storageBucket: "my-dashboard-dc67a.firebasestorage.app",
        messagingSenderId: "710702954120",
        appId: "1:710702954120:web:90e5e9a158f31d9728913d",
        measurementId: "G-47TDJGNE9F"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentEditId = null;
    let allCoinsData = [];

    async function saveData() {
        const numValue = document.getElementById('cNum').value.trim();
        const data = {
            num: numValue,
            price: document.getElementById('cPrice').value,
            status: document.getElementById('cStatus').value,
            imgs: document.getElementById('cUrls').value.split(',').map(s => s.trim()).filter(s => s !== ""),
            desc: document.getElementById('cDesc').value,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        };

        if(!data.num || data.imgs.length === 0) return alert("–ó–∞–ø–æ–ª–Ω–∏ –Ω–æ–º–µ—Ä –∏ —Ñ–æ—Ç–æ!");

        // –ü–†–û–í–ï–†–ö–ê –ù–ê –î–£–ë–õ–ò–ö–ê–¢ –ù–û–ú–ï–†–ê
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –º–æ–Ω–µ—Ç—ã (currentEditId === null)
        if(!currentEditId) {
            const isDuplicate = allCoinsData.some(c => c.num === data.num);
            if(isDuplicate) {
                return alert("–û—à–∏–±–∫–∞! –ú–æ–Ω–µ—Ç–∞ —Å –Ω–æ–º–µ—Ä–æ–º " + data.num + " —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ.");
            }
        }

        if(currentEditId) {
            await db.collection("my_coins").doc(currentEditId).update(data);
            currentEditId = null;
        } else {
            await db.collection("my_coins").add(data);
        }
        resetForm();
    }

    function editCoin(id) {
        const coin = allCoinsData.find(c => c.id === id);
        currentEditId = id;
        document.getElementById('cNum').value = coin.num;
        document.getElementById('cPrice').value = coin.price;
        document.getElementById('cStatus').value = coin.status;
        document.getElementById('cUrls').value = coin.imgs ? coin.imgs.join(', ') : "";
        document.getElementById('cDesc').value = coin.desc;
        document.getElementById('mainBtn').innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø";
        document.getElementById('mainBtn').classList.add('edit-mode');
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        currentEditId = null;
        ['cNum', 'cPrice', 'cUrls', 'cDesc'].forEach(i => document.getElementById(i).value = "");
        document.getElementById('mainBtn').innerText = "–î–û–ë–ê–í–ò–¢–¨ –í –ë–ê–ó–£";
        document.getElementById('mainBtn').classList.remove('edit-mode');
        document.getElementById('cancelBtn').style.display = "none";
    }

    db.collection("my_coins").orderBy("lastUpdate", "desc").onSnapshot(snap => {
        allCoinsData = snap.docs.map(d => ({id: d.id, ...d.data()}));
        render();
    });

    function render() {
        const grid = document.getElementById('coinGrid');
        const query = document.getElementById('searchInput').value.toLowerCase();
        const sortBy = document.getElementById('sortSelect').value;
        
        grid.innerHTML = "";

        // –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        let filteredData = [...allCoinsData];

        // 1. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –ø–æ–∏—Å–∫—É
        if(query) {
            filteredData = filteredData.filter(coin => {
                return `${coin.num} ${coin.desc} ${coin.price}`.toLowerCase().includes(query);
            });
        }

        // 2. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filteredData.sort((a, b) => {
            if (sortBy === 'numAsc') {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏–∑ –Ω–æ–º–µ—Ä–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–Ω–∞–ø—Ä. "#10" -> 10)
                const numA = parseInt(a.num.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.num.replace(/\D/g, '')) || 0;
                return numA - numB;
            } 
            if (sortBy === 'alpha') {
                return a.desc.localeCompare(b.desc);
            }
            if (sortBy === 'lastUpdate') {
                // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (—É–∂–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –±–∞–∑–æ–π, –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                return 0; 
            }
            return 0;
        });

        filteredData.forEach(coin => {
            const photos = coin.imgs || [];
            let galleryHtml = photos.map(url => `<img src="${url}" onclick="window.open('${url}')">`).join('');

            grid.innerHTML += `
                <div class="coin-card">
                    <button class="btn-card btn-del" onclick="deleteCoin('${coin.id}')">‚úï</button>
                    <div class="coin-gallery">${galleryHtml}</div>
                    <div class="coin-info">
                        <div class="coin-title-row">
                            <span class="coin-id"># ${coin.num}</span>
                            <span class="coin-price">${coin.price}</span>
                        </div>
                        <div style="color:${coin.status === '–ü—Ä–æ–¥–∞–Ω–æ' ? '#e74c3c' : '#2ecc71'}; font-weight:bold; margin-bottom:10px;">
                            ${coin.status}
                        </div>
                        <div class="coin-desc">${coin.desc}</div>
                        <div class="card-btns">
                            <button class="btn-card" onclick="editCoin('${coin.id}')">–ò–ó–ú–ï–ù–ò–¢–¨</button>
                            <button class="btn-card" onclick="toggleQuickStatus('${coin.id}', '${coin.status}')">–°–¢–ê–¢–£–°</button>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    async function toggleQuickStatus(id, stat) {
        const next = stat === '–í –Ω–∞–ª–∏—á–∏–∏' ? '–ü—Ä–æ–¥–∞–Ω–æ' : '–í –Ω–∞–ª–∏—á–∏–∏';
        await db.collection("my_coins").doc(id).update({status: next});
    }

    async function deleteCoin(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –º–æ–Ω–µ—Ç—É?")) await db.collection("my_coins").doc(id).delete();
    }
</script>

</body>
</html>
