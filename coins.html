<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Coin Archive Pro + Sales Analytics</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #0a0a0a; --card: #161616; --gold: #f1c40f; --text: #e0e0e0; --blue: #3498db; --green: #2ecc71; --red: #e74c3c; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
        .stats-panel { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid #333; text-align: center; }
        .stat-card b { display: block; font-size: 24px; color: var(--gold); }
        .stat-card span { font-size: 12px; color: #888; text-transform: uppercase; }

        .admin-panel { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #333; margin-bottom: 20px; position: sticky; top: 10px; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .inputs-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        input, textarea, select { background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 6px; width: 100%; box-sizing: border-box; font-size: 14px; }
        
        .filter-bar { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #333; }
        .search-input { border: 1px solid var(--gold) !important; }
        .filter-select { border: 1px solid var(--blue) !important; cursor: pointer; }

        .btn-main { background: var(--gold); color: #000; border: none; padding: 15px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.3s; }
        .btn-main.edit-mode { background: var(--blue); color: #fff; }

        .coin-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        .coin-card { background: var(--card); border-radius: 12px; overflow: hidden; border: 1px solid #333; position: relative; transition: 0.3s; }
        .coin-card:hover { border-color: var(--gold); }
        
        .coin-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 5px; background: #000; padding: 5px; min-height: 150px; }
        .coin-gallery img { width: 100%; height: 140px; object-fit: cover; cursor: pointer; border-radius: 4px; }

        .coin-info { padding: 20px; }
        .coin-title-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .coin-id { color: var(--gold); font-size: 22px; font-weight: bold; }
        .coin-price { font-size: 18px; font-weight: bold; }
        .coin-desc { color: #bbb; font-size: 14px; line-height: 1.5; margin-bottom: 15px; white-space: pre-wrap; }

        .card-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-card { padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; background: #222; color: #fff; }
        .btn-del { background: var(--red); position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; z-index: 5; line-height: 30px; text-align: center; }
        
        .sale-badge { background: rgba(46, 204, 113, 0.1); border: 1px dashed var(--green); padding: 8px; border-radius: 6px; margin-top: 10px; font-size: 12px; }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-panel" id="statsPanel" style="display: none;">
        <div class="stat-card">
            <span id="statTitle">–í—Å–µ–≥–æ –≤—ã—Ä—É—á–∫–∞</span>
            <b id="totalRevenue">0</b>
        </div>
        <div class="stat-card">
            <span>–ü—Ä–æ–¥–∞–Ω–æ —à—Ç—É–∫</span>
            <b id="totalSoldQty">0</b>
        </div>
        <div class="stat-box-small" style="display: flex; flex-direction: column; justify-content: center;">
            <div style="text-align: center;">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫: <span id="avgCheck" style="color: var(--blue); font-weight: bold;">0</span></div>
        </div>
    </div>

    <div class="admin-panel">
        <div class="inputs-row">
            <input type="text" id="cNum" placeholder="–ù–æ–º–µ—Ä (–Ω–∞–ø—Ä. 102)">
            <input type="text" id="cPrice" placeholder="–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞ (–Ω–∞–ø—Ä. 500)">
            <select id="cStatus">
                <option value="–í –Ω–∞–ª–∏—á–∏–∏">–í –Ω–∞–ª–∏—á–∏–∏</option>
                <option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω–æ</option>
            </select>
        </div>
        <textarea id="cUrls" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é..." rows="2"></textarea>
        <textarea id="cDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–Ω–µ—Ç—ã..." rows="2" style="margin-top:10px"></textarea>
        
        <button id="mainBtn" class="btn-main" onclick="saveData()">–î–û–ë–ê–í–ò–¢–¨ –í –ë–ê–ó–£</button>
        <button id="cancelBtn" onclick="resetForm()" style="display:none; background:none; color:gray; border:none; width:100%; margin-top:10px; cursor:pointer;">–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        
        <div class="filter-bar">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –Ω–æ–º–µ—Ä—É..." oninput="render()">
            
            <select id="sortSelect" class="filter-select" onchange="render()">
                <option value="lastUpdate">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º.</option>
                <option value="numAsc">–ü–æ –Ω–æ–º–µ—Ä—É (1-9)</option>
                <option value="numDesc">–ü–æ –Ω–æ–º–µ—Ä—É (9-1)</option>
                <option value="alpha">–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ê-–Ø)</option>
            </select>

            <select id="filterStatus" class="filter-select" onchange="render()">
                <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="–í –Ω–∞–ª–∏—á–∏–∏">–í –Ω–∞–ª–∏—á–∏–∏</option>
                <option value="–ü—Ä–æ–¥–∞–Ω–æ">–ü—Ä–æ–¥–∞–Ω–æ</option>
            </select>
        </div>
    </div>

    <div id="coinGrid" class="coin-grid"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3QRDLzkS9-NnupC5KN65fMv1j39ZovsI",
        authDomain: "my-dashboard-dc67a.firebaseapp.com",
        projectId: "my-dashboard-dc67a",
        storageBucket: "my-dashboard-dc67a.firebasestorage.app",
        messagingSenderId: "710702954120",
        appId: "1:710702954120:web:90e5e9a158f31d9728913d",
        measurementId: "G-47TDJGNE9F"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    let currentEditId = null;
    let allCoinsData = [];

    async function saveData() {
        const numValue = document.getElementById('cNum').value.trim();
        const data = {
            num: numValue,
            price: document.getElementById('cPrice').value,
            status: document.getElementById('cStatus').value,
            imgs: document.getElementById('cUrls').value.split(',').map(s => s.trim()).filter(s => s !== ""),
            desc: document.getElementById('cDesc').value,
            lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
        };

        if(!data.num || data.imgs.length === 0) return alert("–ó–∞–ø–æ–ª–Ω–∏ –Ω–æ–º–µ—Ä –∏ —Ñ–æ—Ç–æ!");

        if(currentEditId) {
            await db.collection("my_coins").doc(currentEditId).update(data);
            currentEditId = null;
        } else {
            await db.collection("my_coins").add(data);
        }
        resetForm();
    }

    db.collection("my_coins").orderBy("lastUpdate", "desc").onSnapshot(snap => {
        allCoinsData = snap.docs.map(d => ({id: d.id, ...d.data()}));
        render();
    });

    function render() {
        const grid = document.getElementById('coinGrid');
        const query = document.getElementById('searchInput').value.toLowerCase();
        const sortBy = document.getElementById('sortSelect').value;
        const filterStatus = document.getElementById('filterStatus').value;
        
        grid.innerHTML = "";

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ñ–∏–ª—å—Ç—Ä "–ü—Ä–æ–¥–∞–Ω–æ"
        const statsPanel = document.getElementById('statsPanel');
        if(filterStatus === "–ü—Ä–æ–¥–∞–Ω–æ") {
            statsPanel.style.display = "grid";
            updateStats(allCoinsData.filter(c => c.status === "–ü—Ä–æ–¥–∞–Ω–æ"));
        } else {
            statsPanel.style.display = "none";
        }

        let filteredData = [...allCoinsData];

        if(filterStatus !== "all") {
            filteredData = filteredData.filter(coin => coin.status === filterStatus);
        }

        if(query) {
            filteredData = filteredData.filter(coin => {
                return `${coin.num} ${coin.desc} ${coin.price}`.toLowerCase().includes(query);
            });
        }

        filteredData.sort((a, b) => {
            const numA = parseInt(a.num.replace(/\D/g, '')) || 0;
            const numB = parseInt(b.num.replace(/\D/g, '')) || 0;
            if (sortBy === 'numAsc') return numA - numB;
            if (sortBy === 'numDesc') return numB - numA;
            if (sortBy === 'alpha') return (a.desc || "").localeCompare(b.desc || "");
            return 0;
        });

        filteredData.forEach(coin => {
            const photos = coin.imgs || [];
            let galleryHtml = photos.map(url => `<img src="${url}" onclick="window.open('${url}')">`).join('');
            
            let saleInfoHtml = "";
            if(coin.status === "–ü—Ä–æ–¥–∞–Ω–æ" && coin.saleTotal) {
                saleInfoHtml = `
                    <div class="sale-badge">
                        üí∞ –ü—Ä–æ–¥–∞–Ω–æ: <b>${coin.saleTotal}</b> (${coin.saleQty} —à—Ç. –ø–æ ${coin.salePrice})
                    </div>
                `;
            }

            grid.innerHTML += `
                <div class="coin-card">
                    <button class="btn-card btn-del" onclick="deleteCoin('${coin.id}')">‚úï</button>
                    <div class="coin-gallery">${galleryHtml}</div>
                    <div class="coin-info">
                        <div class="coin-title-row">
                            <span class="coin-id"># ${coin.num}</span>
                            <span class="coin-price">${coin.price}</span>
                        </div>
                        <div style="color:${coin.status === '–ü—Ä–æ–¥–∞–Ω–æ' ? 'var(--red)' : 'var(--green)'}; font-weight:bold;">
                            ${coin.status}
                        </div>
                        ${saleInfoHtml}
                        <div class="coin-desc" style="margin-top:10px">${coin.desc}</div>
                        <div class="card-btns">
                            <button class="btn-card" onclick="editCoin('${coin.id}')">–ò–ó–ú–ï–ù–ò–¢–¨</button>
                            <button class="btn-card" onclick="toggleQuickStatus('${coin.id}', '${coin.status}', '${coin.price}')">–°–¢–ê–¢–£–°</button>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function updateStats(soldCoins) {
        let totalRev = 0;
        let totalQty = 0;

        soldCoins.forEach(c => {
            totalRev += parseFloat(c.saleTotal || 0);
            totalQty += parseInt(c.saleQty || 0);
        });

        document.getElementById('totalRevenue').innerText = totalRev.toFixed(2);
        document.getElementById('totalSoldQty').innerText = totalQty;
        document.getElementById('avgCheck').innerText = totalQty > 0 ? (totalRev / totalQty).toFixed(2) : 0;
    }

    async function toggleQuickStatus(id, stat, currentPrice) {
        if (stat === '–í –Ω–∞–ª–∏—á–∏–∏') {
            // –ü–µ—Ä–µ—Ö–æ–¥ –≤ "–ü—Ä–æ–¥–∞–Ω–æ" ‚Äî –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const qty = prompt("–°–∫–æ–ª—å–∫–æ —à—Ç—É–∫ –ø—Ä–æ–¥–∞–Ω–æ?", "1");
            if (qty === null) return;
            
            const pricePerOne = prompt("–¶–µ–Ω–∞ –∑–∞ 1 —à—Ç?", currentPrice.replace(/\D/g, ''));
            if (pricePerOne === null) return;

            const total = parseFloat(qty) * parseFloat(pricePerOne);

            await db.collection("my_coins").doc(id).update({
                status: '–ü—Ä–æ–¥–∞–Ω–æ',
                saleQty: qty,
                salePrice: pricePerOne,
                saleTotal: total
            });
        } else {
            // –í–æ–∑–≤—Ä–∞—Ç –≤ "–í –Ω–∞–ª–∏—á–∏–∏" ‚Äî —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–µ
            if(confirm("–í–µ—Ä–Ω—É—Ç—å –º–æ–Ω–µ—Ç—É –≤ –Ω–∞–ª–∏—á–∏–µ? –î–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.")) {
                await db.collection("my_coins").doc(id).update({
                    status: '–í –Ω–∞–ª–∏—á–∏–∏',
                    saleQty: firebase.firestore.FieldValue.delete(),
                    salePrice: firebase.firestore.FieldValue.delete(),
                    saleTotal: firebase.firestore.FieldValue.delete()
                });
            }
        }
    }

    function editCoin(id) {
        const coin = allCoinsData.find(c => c.id === id);
        currentEditId = id;
        document.getElementById('cNum').value = coin.num;
        document.getElementById('cPrice').value = coin.price;
        document.getElementById('cStatus').value = coin.status;
        document.getElementById('cUrls').value = coin.imgs ? coin.imgs.join(', ') : "";
        document.getElementById('cDesc').value = coin.desc;
        document.getElementById('mainBtn').innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø";
        document.getElementById('mainBtn').classList.add('edit-mode');
        document.getElementById('cancelBtn').style.display = "block";
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function resetForm() {
        currentEditId = null;
        ['cNum', 'cPrice', 'cUrls', 'cDesc'].forEach(i => document.getElementById(i).value = "");
        document.getElementById('mainBtn').innerText = "–î–û–ë–ê–í–ò–¢–¨ –í –ë–ê–ó–£";
        document.getElementById('mainBtn').classList.remove('edit-mode');
        document.getElementById('cancelBtn').style.display = "none";
    }

    async function deleteCoin(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –º–æ–Ω–µ—Ç—É?")) await db.collection("my_coins").doc(id).delete();
    }
</script>

</body>
</html>
