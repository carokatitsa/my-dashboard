<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Pro Nutri Tracker v3.2</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --accent: #238636; --blue: #58a6ff; --text: #c9d1d9; --border: #30363d; --danger: #f85149; --gold: #f1c40f; --grey-text: #8b949e; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 380px 1fr; gap: 20px; width: 100%; }
        
        /* –®–∞–ø–∫–∞ –ö–ë–ñ–£ */
        .goals-header { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .goal-item { text-align: center; }
        .goal-label-row { display: flex; justify-content: center; align-items: baseline; gap: 5px; margin-bottom: 5px; font-size: 11px; font-weight: bold; color: var(--grey-text); }
        .current-val { font-size: 16px; color: var(--blue); }
        .goal-item input { width: 100%; max-width: 80px; text-align: center; font-weight: bold; background: #0d1117; border: 1px solid var(--border); color: #fff; border-radius: 4px; padding: 4px; font-size: 13px; margin-top: 5px; }
        .progress-mini { height: 6px; background: #30363d; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); transition: 0.3s; width: 0%; }

        /* –û—Ç—á–µ—Ç */
        .summary-card { background: linear-gradient(145deg, #1c2128, #161b22); border: 2px solid var(--gold); border-radius: 12px; padding: 20px; margin-bottom: 20px; display: none; z-index: 1000; position: relative; }
        .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .stat-box { background: #0d1117; padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-box big { display: block; font-size: 24px; font-weight: bold; margin: 5px 0; }

        /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 15px; height: fit-content; position: sticky; top: 15px; }
        .main-input { width: 100%; background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
        .bju-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
        .bju-row input { width: 100%; padding: 8px; text-align: center; font-size: 12px; background: #0d1117; border: 1px solid var(--border); color: white; border-radius: 6px; }
        
        .btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-add { background: var(--accent); color: white; }
        .btn-finish { background: var(--gold); color: #000; margin-top: 20px; font-size: 14px; }

        /* –ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ (–§–∏–∫—Å –∫–Ω–æ–ø–æ–∫) */
        .lib-list { margin-top: 15px; max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .lib-card { background: #21262d; border: 1px solid var(--border); padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .lib-info { flex: 1; overflow: hidden; }
        .lib-info b { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 13px; color: #fff; }
        .lib-actions { display: flex; gap: 5px; flex-shrink: 0; }
        .btn-sm { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: #30363d; color: #fff; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }

        /* –ò—Å—Ç–æ—Ä–∏—è */
        .day-block { margin-bottom: 15px; background: #161b22; border-radius: 10px; border: 1px solid var(--border); overflow: hidden; }
        .day-header { background: #1c2128; padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .day-info { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        
        /* –°—Ç—Ä–æ–∫–∞ –ö–ë–ñ–£ –≤ –∏—Å—Ç–æ—Ä–∏–∏ */
        .day-stats-brief { 
            font-size: 11px; 
            color: #ccc; 
            background: #2d333b; 
            padding: 4px 12px; 
            border-radius: 6px; 
            display: flex; 
            gap: 12px;
            border: 1px solid var(--border);
        }
        .day-stats-brief b { color: #ffffff; font-weight: 800; } /* –ë–µ–ª—ã–µ –∏ –∂–∏—Ä–Ω—ã–µ –ë–ñ–£ */
        .stat-val-pos { color: var(--danger) !important; } /* –ü–ª—é—Å - –∫—Ä–∞—Å–Ω—ã–π (–∂–∏—Ä +) */
        .stat-val-neg { color: #56d364 !important; } /* –ú–∏–Ω—É—Å - –∑–µ–ª–µ–Ω—ã–π (–∂–∏—Ä -) */

        .eat-list { padding: 10px; display: block; }
        .eat-list.collapsed { display: none; }
        .eat-card { background: #0d1117; border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .del-btn { color: var(--danger); background: none; border: none; cursor: pointer; font-size: 18px; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } .goals-header { grid-template-columns: repeat(2, 1fr); } }
    </style>
</head>
<body>

<div id="summaryDisplay" class="summary-card">
    <h2 style="margin:0; color: var(--gold); text-align: center;">üèÜ –ò—Ç–æ–≥–∏ –¥–Ω—è</h2>
    <div class="summary-grid">
        <div class="stat-box">
            <small>–ò–ó–ú–ï–ù–ï–ù–ò–ï –ñ–ò–†–ê</small>
            <big id="fatResult">0–≥</big>
            <span id="fatDesc" style="font-size: 11px; color: var(--grey-text);"></span>
        </div>
        <div class="stat-box">
            <small>–°–¢–ê–¢–£–° –ú–´–®–¶</small>
            <big id="muscleResult" style="font-size: 18px;">‚Äî</big>
            <span id="muscleDesc" style="font-size: 11px; color: var(--grey-text);"></span>
        </div>
    </div>
    <button class="btn" style="background:none; color:var(--blue); margin-top:15px;" onclick="closeSummary()">–ó–∞–∫—Ä—ã—Ç—å –æ—Ç—á–µ—Ç</button>
</div>

<div class="goals-header" id="mainHeader">
    <div class="goal-item">
        <div class="goal-label-row">–ö–ö–ê–õ <span id="curK" class="current-val">0</span></div>
        <input type="number" id="goalK" value="2300" oninput="renderHistory()">
        <div class="progress-mini"><div id="barK" class="progress-fill"></div></div>
    </div>
    <div class="goal-item">
        <div class="goal-label-row">–ë–ï–õ–ö–ò <span id="curP" class="current-val">0</span></div>
        <input type="number" id="goalP" value="170" oninput="renderHistory()">
        <div class="progress-mini"><div id="barP" class="progress-fill"></div></div>
    </div>
    <div class="goal-item">
        <div class="goal-label-row">–ñ–ò–†–´ <span id="curF" class="current-val">0</span></div>
        <input type="number" id="goalF" value="70" oninput="renderHistory()">
        <div class="progress-mini"><div id="barF" class="progress-fill"></div></div>
    </div>
    <div class="goal-item">
        <div class="goal-label-row">–£–ì–õ–ï–í–û–î–´ <span id="curC" class="current-val">0</span></div>
        <input type="number" id="goalC" value="240" oninput="renderHistory()">
        <div class="progress-mini"><div id="barC" class="progress-fill"></div></div>
    </div>
</div>

<div class="container">
    <div class="panel">
        <h2 style="margin: 0 0 15px 0; font-size: 18px;">üì¶ –ë–∞–∑–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h2>
        <input type="text" id="pName" class="main-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±–ª—é–¥–∞">
        <div class="bju-row">
            <input type="number" id="pP" placeholder="–ë">
            <input type="number" id="pF" placeholder="–ñ">
            <input type="number" id="pC" placeholder="–£">
            <input type="number" id="pK" placeholder="–ö–∫–∞–ª">
        </div>
        <label style="font-size:12px; color:var(--gold); display:flex; align-items:center; gap:5px; margin-bottom:15px; cursor:pointer;">
            <input type="checkbox" id="pIsPortion"> –¶–µ–ª–∞—è –ø–æ—Ä—Ü–∏—è
        </label>
        <button id="saveBtn" class="btn btn-add" onclick="saveToLib()">–°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£</button>
        <button id="cancelBtn" style="display:none; background:none; color:gray; border:none; margin-top:8px; cursor:pointer; width:100%;" onclick="resetForm()">–û—Ç–º–µ–Ω–∞</button>
        
        <input type="text" id="libSearch" class="main-input" style="margin-top:20px; border-color: var(--blue);" placeholder="üîç –ü–æ–∏—Å–∫..." oninput="renderLibrary()">
        <div id="libraryList" class="lib-list"></div>

        <button class="btn btn-finish" onclick="finishDay()">‚úÖ –ó–ê–í–ï–†–®–ò–¢–¨ –î–ï–ù–¨</button>
    </div>

    <div id="history"></div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyA3QRDLzkS9-NnupC5KN65fMv1j39ZovsI",
        authDomain: "my-dashboard-dc67a.firebaseapp.com",
        projectId: "my-dashboard-dc67a",
        storageBucket: "my-dashboard-dc67a.firebasestorage.app",
        messagingSenderId: "710702954120",
        appId: "1:710702954120:web:90e5e9a158f31d9728913d"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let library = [];
    let logs = [];
    let summaries = {};
    let totals = { k:0, p:0, f:0, c:0 };
    let editId = null;
    let isDayFinished = false;

    // --- –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• ---
    db.collection("food_library").onSnapshot(snap => { library = snap.docs.map(d => ({id: d.id, ...d.data()})); renderLibrary(); });
    db.collection("daily_summaries").onSnapshot(snap => { summaries = {}; snap.forEach(doc => { summaries[doc.data().date] = doc.data(); }); renderHistory(); });
    db.collection("day_logs").orderBy("ts", "desc").onSnapshot(snap => { logs = snap.docs.map(d => ({id: d.id, ...d.data()})); renderHistory(); });

    // --- –û–¢–†–ò–°–û–í–ö–ê –ë–ê–ó–´ ---
    function renderLibrary() {
        const q = document.getElementById('libSearch').value.toLowerCase();
        const list = document.getElementById('libraryList');
        list.innerHTML = "";
        library.filter(i => i.name.toLowerCase().includes(q)).forEach(item => {
            list.innerHTML += `<div class="lib-card">
                <div class="lib-info"><b>${item.name}</b><small>–ë:${item.p} –ñ:${item.f} –ö:${item.k}</small></div>
                <div class="lib-actions">
                    <button class="btn-sm" style="background:var(--accent)" onclick="addToDay('${item.id}')">+</button>
                    <button class="btn-sm" onclick="editProduct('${item.id}')">‚úèÔ∏è</button>
                    <button class="btn-sm" style="background:var(--danger)" onclick="deleteFromLib('${item.id}')">üóëÔ∏è</button>
                </div>
            </div>`;
        });
    }

    // --- –û–¢–†–ò–°–û–í–ö–ê –ò–°–¢–û–†–ò–ò –ò –®–ê–ü–ö–ò ---
    function renderHistory() {
        const container = document.getElementById('history');
        const today = new Date().toLocaleDateString('ru-RU');
        const groups = {};
        totals = { k:0, p:0, f:0, c:0 };

        logs.forEach(l => {
            if(!groups[l.date]) groups[l.date] = [];
            groups[l.date].push(l);
            if(l.date === today) { 
                totals.k += Number(l.k); totals.p += Number(l.p); totals.f += Number(l.f); totals.c += Number(l.c); 
            }
        });

        // –û–±–Ω—É–ª–µ–Ω–∏–µ —à–∞–ø–∫–∏ –µ—Å–ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ —Ñ–∏–Ω–∏—à–∞
        const displayK = isDayFinished ? 0 : totals.k;
        const displayP = isDayFinished ? 0 : totals.p;
        const displayF = isDayFinished ? 0 : totals.f;
        const displayC = isDayFinished ? 0 : totals.c;

        const up = (idC, idB, cur, idG) => {
            const g = parseFloat(document.getElementById(idG).value) || 1;
            document.getElementById(idC).innerText = Math.round(cur);
            document.getElementById(idB).style.width = Math.min((cur/g)*100, 100) + "%";
            document.getElementById(idB).style.background = cur > g ? "var(--danger)" : "var(--accent)";
        };
        up('curK', 'barK', displayK, 'goalK'); up('curP', 'barP', displayP, 'goalP');
        up('curF', 'barF', displayF, 'goalF'); up('curC', 'barC', displayC, 'goalC');

        let html = "";
        for (const date in groups) {
            const isToday = date === today;
            const s = summaries[date];
            let brief = "";
            
            if (s) {
                // –ü–†–û–í–ï–†–ö–ê –ó–ù–ê–ö–ê –ñ–ò–†–ê –î–õ–Ø –¶–í–ï–¢–ê
                const fatVal = parseFloat(s.fatChange);
                const isNegative = fatVal < 0;
                const fatClass = isNegative ? 'stat-val-neg' : 'stat-val-pos';
                const sign = fatVal > 0 ? "+" : ""; 

                brief = `<div class="day-stats-brief">
                    <span><b>${Math.round(s.totals.k)}</b> –∫–∫–∞–ª</span>
                    <span>–ë:<b>${Math.round(s.totals.p)}</b> –ñ:<b>${Math.round(s.totals.f)}</b> –£:<b>${Math.round(s.totals.c)}</b></span>
                    <span class="${fatClass}"><b>${sign}${fatVal}–≥ –∂–∏—Ä–∞</b></span>
                    <span>${s.muscleStatus}</span>
                </div>`;
            } else if (isToday) { 
                brief = `<div class="day-stats-brief">–í –ø—Ä–æ—Ü–µ—Å—Å–µ...</div>`; 
            }

            html += `<div class="day-block">
                <div class="day-header" onclick="toggleDay('${date}')">
                    <div class="day-info"><b style="color:${isToday?'var(--blue)':'#fff'}">${isToday?'–°–ï–ì–û–î–ù–Ø':date}</b>${brief}</div>
                    <span style="font-size:10px">${isToday?'‚ñº':'‚ñ∂'}</span>
                </div>
                <div id="list-${date}" class="eat-list ${!isToday?'collapsed':''}">
                    ${groups[date].map(i => `
                        <div class="eat-card">
                            <div style="flex:1"><b>${i.name}</b><br><small>${i.w}${typeof i.w==='number'?'–≥':''} | –ë:${i.p} –ñ:${i.f} –ö:${i.k}</small></div>
                            <button class="del-btn" onclick="deleteLog('${i.id}')">√ó</button>
                        </div>`).join('')}
                </div>
            </div>`;
        }
        container.innerHTML = html;
    }

    // --- –§–ò–ù–ê–õ –î–ù–Ø ---
    async function finishDay() {
        const gK = parseFloat(document.getElementById('goalK').value) || 2300;
        const gP = parseFloat(document.getElementById('goalP').value) || 170;
        
        // –†–ê–°–ß–ï–¢ –î–ï–§–ò–¶–ò–¢–ê: (–°—ä–µ–ª - –¶–µ–ª—å). –ï—Å–ª–∏ 2200 - 2300 = -100.
        const kcalDiff = totals.k - gK; 
        const fatChange = parseFloat((kcalDiff / 7.7).toFixed(1)); 
        
        let mStat = "–£–î–ï–†–ñ–ê–ù–ò–ï";
        if (totals.p >= gP) { 
            mStat = (totals.k >= (gK - 200)) ? "–†–û–°–¢ üí™" : "–°–û–•–†–ê–ù–ï–ù–ò–ï"; 
        } else { 
            mStat = "–£–ë–´–õ–¨ ‚ö†Ô∏è"; 
        }

        // –í—Å–ø–ª—ã–≤–∞—é—â–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞
        const fatResEl = document.getElementById('fatResult');
        fatResEl.innerText = (fatChange > 0 ? "+" : "") + fatChange + "–≥";
        fatResEl.style.color = fatChange <= 0 ? "var(--accent)" : "var(--danger)";
        document.getElementById('fatDesc').innerText = fatChange <= 0 ? "–ñ–∏—Ä–∞ —Å–æ–∂–∂–µ–Ω–æ" : "–ñ–∏—Ä –≤ –∑–∞–ø–∞—Å";
        document.getElementById('muscleResult').innerText = mStat;
        
        isDayFinished = true;
        renderHistory();

        document.getElementById('summaryDisplay').style.display = 'block';
        window.scrollTo({top: 0, behavior: 'smooth'});

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase
        await db.collection("daily_summaries").doc(new Date().toLocaleDateString('ru-RU')).set({
            date: new Date().toLocaleDateString('ru-RU'),
            totals: {...totals},
            fatChange: fatChange,
            muscleStatus: mStat,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // --- –§–£–ù–ö–¶–ò–ò –ë–ê–ó–´ ---
    async function saveToLib() {
        const name = document.getElementById('pName').value;
        const p = parseFloat(document.getElementById('pP').value) || 0;
        const f = parseFloat(document.getElementById('pF').value) || 0;
        const c = parseFloat(document.getElementById('pC').value) || 0;
        const k = parseFloat(document.getElementById('pK').value) || (p*4 + f*9 + c*4);
        const isPortion = document.getElementById('pIsPortion').checked;
        if(!name) return;
        const data = { name, p, f, c, k: Math.round(k), isPortion };
        if(editId) { await db.collection("food_library").doc(editId).update(data); editId = null; }
        else { await db.collection("food_library").add(data); }
        resetForm();
    }

    async function addToDay(id) {
        isDayFinished = false; 
        const p = library.find(x => x.id === id);
        let w = p.isPortion ? "–ø–æ—Ä—Ü–∏—è" : prompt("–í–µ—Å –≤ –≥—Ä–∞–º–º–∞—Ö?", "100");
        if (!w) return;
        let d = { ...p, w: w === "–ø–æ—Ä—Ü–∏—è" ? w : parseFloat(w) };
        if (!p.isPortion) { 
            const r = parseFloat(w)/100; 
            d.p=+(p.p*r).toFixed(1); d.f=+(p.f*r).toFixed(1); d.c=+(p.c*r).toFixed(1); d.k=+(p.k*r).toFixed(0); 
        }
        delete d.id; 
        await db.collection("day_logs").add({ ...d, date: new Date().toLocaleDateString('ru-RU'), ts: firebase.firestore.FieldValue.serverTimestamp() });
    }

    function resetForm() {
        editId = null;
        ['pName','pP','pF','pC','pK'].forEach(i => document.getElementById(i).value = "");
        document.getElementById('pIsPortion').checked = false;
        document.getElementById('saveBtn').innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£";
        document.getElementById('cancelBtn').style.display = "none";
    }

    async function deleteLog(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) await db.collection("day_logs").doc(id).delete(); }
    async function deleteFromLib(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã?")) await db.collection("food_library").doc(id).delete(); }
    
    function editProduct(id) {
        const i = library.find(x => x.id === id);
        document.getElementById('pName').value = i.name; document.getElementById('pP').value = i.p;
        document.getElementById('pF').value = i.f; document.getElementById('pC').value = i.c;
        document.getElementById('pK').value = i.k; document.getElementById('pIsPortion').checked = i.isPortion;
        editId = id; document.getElementById('saveBtn').innerText = "–û–ë–ù–û–í–ò–¢–¨"; document.getElementById('cancelBtn').style.display = "block";
    }

    function toggleDay(date) { document.getElementById(`list-${date}`).classList.toggle('collapsed'); }
    function closeSummary() { 
        document.getElementById('summaryDisplay').style.display = 'none'; 
        const today = new Date().toLocaleDateString('ru-RU');
        const list = document.getElementById(`list-${today}`);
        if(list) list.classList.add('collapsed');
    }
</script>
</body>
</html>
