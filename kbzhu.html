<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–ú–æ–π –ö–ë–ñ–£ –î–Ω–µ–≤–Ω–∏–∫</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --bg: #0b0f19; --card: #161b22; --accent: #3fb950; --text: #c9d1d9; --blue: #58a6ff; --border: #30363d; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; padding: 15px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1.2fr; gap: 25px; }
        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }
        
        h2 { border-bottom: 1px solid var(--border); padding-bottom: 10px; color: var(--blue); display: flex; justify-content: space-between; align-items: center; }
        .panel { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid var(--border); }
        
        input { background: #0d1117; border: 1px solid var(--border); color: white; padding: 10px; border-radius: 6px; box-sizing: border-box; }
        .grid-bju { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }

        .btn { border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-add { background: var(--accent); color: white; width: 100%; margin-top: 5px; }
        .btn-select { background: var(--blue); color: white; font-size: 11px; padding: 5px 10px; }

        /* –°–ø–∏—Å–æ–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ */
        .lib-scroll { max-height: 400px; overflow-y: auto; margin-top: 15px; }
        .list-item { background: #21262d; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        
        /* –ò—Å—Ç–æ—Ä–∏—è –¥–Ω–µ–≤–Ω–∏–∫–∞ */
        .day-group { margin-bottom: 30px; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: #0d1117; }
        .day-header { background: #21262d; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .day-header b { color: var(--accent); font-size: 1.1rem; }
        .day-summary-text { font-size: 0.85rem; color: #8b949e; }
        .log-entry { padding: 10px 15px; border-bottom: 1px solid #1c2128; display: flex; justify-content: space-between; align-items: center; }
        .log-entry:last-child { border-bottom: none; }

        .kcal-badge { background: #3fb95022; color: var(--accent); padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .search-bar { width: 100%; margin-bottom: 10px; border-color: var(--blue); }
    </style>
</head>
<body>

<div class="container">
    <div class="section">
        <h2>üì¶ –ú–æ–∏ –ø—Ä–æ–¥—É–∫—Ç—ã</h2>
        <div class="panel">
            <div class="input-group">
                <input type="text" id="libName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞" style="width:100%; margin-bottom:10px;">
                <div class="grid-bju">
                    <input type="number" id="libP" placeholder="–ë">
                    <input type="number" id="libF" placeholder="–ñ">
                    <input type="number" id="libC" placeholder="–£">
                    <input type="number" id="libK" placeholder="–ö–∫–∞–ª">
                </div>
                <small style="color: #8b949e; display:block; margin-bottom:10px;">* –ö–∫–∞–ª –º–æ–∂–Ω–æ –Ω–µ –≤–≤–æ–¥–∏—Ç—å, –ø–æ—Å—á–∏—Ç–∞–µ–º —Å–∞–º–∏</small>
                <button class="btn btn-add" onclick="addToLibrary()">–°–û–•–†–ê–ù–ò–¢–¨ –í –ë–ê–ó–£</button>
            </div>
            
            <input type="text" id="libSearch" class="search-bar" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –±–∞–∑–µ..." oninput="renderLibrary()">
            <div id="libraryList" class="lib-scroll"></div>
        </div>
    </div>

    <div class="section">
        <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –ø–∏—Ç–∞–Ω–∏—è</h2>
        <div id="historyContainer"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA3QRDLzkS9-NnupC5KN65fMv1j39ZovsI",
        authDomain: "my-dashboard-dc67a.firebaseapp.com",
        projectId: "my-dashboard-dc67a",
        storageBucket: "my-dashboard-dc67a.firebasestorage.app",
        messagingSenderId: "710702954120",
        appId: "1:710702954120:web:90e5e9a158f31d9728913d"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let fullLibrary = [];

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
    async function addToLibrary() {
        const name = document.getElementById('libName').value;
        const p = parseFloat(document.getElementById('libP').value) || 0;
        const f = parseFloat(document.getElementById('libF').value) || 0;
        const c = parseFloat(document.getElementById('libC').value) || 0;
        let k = parseFloat(document.getElementById('libK').value);

        // –ê–≤—Ç–æ-—Ä–∞—Å—á–µ—Ç –ö–∫–∞–ª –µ—Å–ª–∏ –ø—É—Å—Ç–æ
        if (!k) k = (p * 4) + (f * 9) + (c * 4);

        if(!name) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ");
        await db.collection("food_library").add({ name, p, f, c, k });
        ['libName', 'libP', 'libF', 'libC', 'libK'].forEach(id => document.getElementById(id).value = "");
    }

    // –†–µ–Ω–¥–µ—Ä –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å –ø–æ–∏—Å–∫–æ–º
    function renderLibrary() {
        const query = document.getElementById('libSearch').value.toLowerCase();
        const list = document.getElementById('libraryList');
        list.innerHTML = "";
        
        fullLibrary.filter(item => item.name.toLowerCase().includes(query)).forEach(d => {
            list.innerHTML += `
                <div class="list-item">
                    <div class="info">
                        <b>${d.name}</b>
                        <small>–ë:${d.p} –ñ:${d.f} –£:${d.c} | <span style="color:var(--accent)">${d.k} –∫–∫–∞–ª</span></small>
                    </div>
                    <div>
                        <button class="btn btn-select" onclick="addEntryToDay('${d.id}')">‚ûï</button>
                        <button onclick="deleteLib('${d.id}')" style="background:none; border:none; color:#f85149; cursor:pointer; margin-left:5px;">‚úï</button>
                    </div>
                </div>`;
        });
    }

    db.collection("food_library").onSnapshot(snap => {
        fullLibrary = snap.docs.map(doc => ({id: doc.id, ...doc.data()}));
        renderLibrary();
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –¥–Ω–µ–≤–Ω–∏–∫
    async function addEntryToDay(libId) {
        const weight = prompt("–í–µ—Å –ø–æ—Ä—Ü–∏–∏ (–≤ –≥—Ä–∞–º–º–∞—Ö)?", "100");
        if (!weight || isNaN(weight)) return;

        const product = fullLibrary.find(i => i.id === libId);
        const ratio = weight / 100;

        await db.collection("day_logs").add({
            name: product.name,
            weight: parseFloat(weight),
            p: +(product.p * ratio).toFixed(1),
            f: +(product.f * ratio).toFixed(1),
            c: +(product.c * ratio).toFixed(1),
            kcal: +(product.k * ratio).toFixed(0),
            date: new Date().toLocaleDateString('ru-RU'),
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // –†–µ–Ω–¥–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ (–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–∞–º)
    db.collection("day_logs").orderBy("ts", "desc").onSnapshot(snap => {
        const container = document.getElementById('historyContainer');
        container.innerHTML = "";
        
        const groups = {};
        snap.forEach(doc => {
            const d = doc.data();
            if (!groups[d.date]) groups[d.date] = { items: [], totalK: 0, totalP: 0, totalF: 0, totalC: 0 };
            groups[d.date].items.push({id: doc.id, ...d});
            groups[d.date].totalK += d.kcal;
            groups[d.date].totalP += d.p;
            groups[d.date].totalF += d.f;
            groups[d.date].totalC += d.c;
        });

        for (const date in groups) {
            const g = groups[date];
            let itemsHtml = g.items.map(item => `
                <div class="log-entry">
                    <div>
                        <b>${item.name}</b> <small style="color:#8b949e">(${item.weight}–≥)</small><br>
                        <small>–ë:${item.p} –ñ:${item.f} –£:${item.c}</small>
                    </div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="kcal-badge">${item.kcal}</span>
                        <button onclick="deleteLog('${item.id}')" style="background:none; border:none; color:#f85149; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');

            container.innerHTML += `
                <div class="day-group">
                    <div class="day-header">
                        <b>${date}</b>
                        <div class="day-summary-text">
                            –ö:${g.totalK.toFixed(0)} –ë:${g.totalP.toFixed(1)} –ñ:${g.totalF.toFixed(1)} –£:${g.totalC.toFixed(1)}
                        </div>
                    </div>
                    ${itemsHtml}
                </div>
            `;
        }
    });

    async function deleteLib(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å –∏–∑ –±–∞–∑—ã?")) await db.collection("food_library").doc(id).delete(); }
    async function deleteLog(id) { await db.collection("day_logs").doc(id).delete(); }
</script>

</body>
</html>
